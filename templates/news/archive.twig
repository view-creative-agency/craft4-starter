{% import '_macros' as macros %}
{% set htmlClass = 'news' %}
{% extends "_layout" %}

{% if year is not defined %}
	{% redirect "news/archive/"~now.year %}
{% endif %}

{% if month is not defined %}
	{% set before = year+1 %}
	{% set after  = year %}
	{% set title = year ~ " | News Archive" %}
{% else %}
	{% if month == 12 %}
		{% set yearBefore = year + 1 %}
		{% set monthBefore = '01' %}

		{% set before = yearBefore~'-'~monthBefore %}
		{% set after = year~'-'~month %}
	{% else %}
		{% set before = year ~ '-' ~ (month+1) %}
		{% set after  = year ~ '-' ~ month %}
	{% endif %}

	{# used to get a textual representation of the month #}
	{% set realMonthFalseDate = "10-"~month~"-2010" %}
	{% set monthName = realMonthFalseDate|date('F') %}

	{% set title = monthName ~ ", " ~ year ~ " | News Archive" %}
{% endif %}

{% block content %}<!-- Template: {{ _self }}.twig -->
	{% do seomatic.meta.robots("noindex,follow") %}

	<main id="main">
		<div class="dc_constrain-centre dc_layout-padding-both dc_grid-1-3 main-right">
			<div class="col1">
				{% set entriesInPeriod = craft.entries
					.section('newsItems')
					.after(after)
					.before(before)
					.orderBy('postDate desc')
					.with([
						'listingImage',
					]).all()
				%}

				<h1>News Archive</h1>
				<div class="tagline">
					<p>
						For {% if month is defined %}{{ monthName|date('F') }} {% endif %}{% if year is defined %}{{ year }}{% else %}{{ now.Y }}{% endif %}.
						There
						{% if entriesInPeriod | length == 0 %}
							are no entries
							{% if year > now|date("Y") %}
								- either my clock is wrong, or you're trying to divine the future
							{% else %}
								- my memory doesn't go back that far
							{% endif %}
						{% elseif entriesInPeriod | length > 1 %}
							are {{ entriesInPeriod | length }} entries
						{% else %}
							is {{ entriesInPeriod | length }} entry
						{% endif %}
						...
					</p>
				</div>

				{% for month, entries in entriesInPeriod | group("postDate|date('F')") | reverse(true) %}
					<div class="section newsItems">
						<div class="container">
							<h2 class="heading-year">{{ month }}</h2>

							{% for newsItem in entries %}
								<div class="newsItem">
									{# output a lazy-loaded webp/jpeg image which becomes a fixed 200px square at breapoint3 #}
									{{ macros.imageChangesShape({
										theImage     : newsItem.listingImage[0] ??? website.missingImageFallback[0],
										transforms   : [
											{ media: '(max-width: 479px)',  width: 480,  height: 240 },
											{ media: '(min-width: 700px)',  width: 400,  height: 400 },
											{ media: '(min-width: 480px)',  width: 700,  height: 400 },
										],
										className: 'media'
									}) }}

									<div class="text">
										<h3>{{ newsItem.title }}</h3>
										<p class="meta">
											Published on {{ newsItem.postDate | date('l jS F Y') }} at {{ newsItem.postDate | date('g:i A') }}
										</p>
										<div class="listingExcerpt">
											{{ newsItem.listingExcerpt }}
										</div>
										<p>
											<a href="{{ newsItem.url }}" class="dc_more">
												Read more<span> about {{ newsItem.title }}</span>
											</a>
										</p>
									</div><!-- .text -->
								</div><!-- .newsItem -->
							{% endfor %}
						</div><!-- .container -->
					</div><!-- .section.newsItems -->
				{% endfor %}
			</div>

			<div class="col2">
				{% include 'news/_nav-categories' %}
				{% include 'news/_nav-archive' %}
				{% include '_partials/social-share' %}
			</div>
		</div>
	</main>
{% endblock %}
